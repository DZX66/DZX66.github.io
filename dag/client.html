<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <title>Draw&Guess</title>
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <meta charset="utf-8">
    <meta name="referrer" content="no-referrer">
</head>

<body>
    <!-- 画板css -->
    <style>
        .content {
            margin: 20px;
            margin-bottom: 5px;
            float: left;
        }

        .content div {
            margin-bottom: 10px;
            width: 80px;
            text-align: center;
            float: left;
        }

        .toolbar {
            top: 0;
            height: auto;
            width: 100%;
            position: absolute;
            z-index: 999;
            background-color: bisque;
            border: 1px solid #ccc;
        }

        .toolbar_btn {
            background: url("toolbar_btn.png");
            background-repeat: no-repeat;
            background-size: 100%;
            width: 60px;
            height: 38px;
        }

        .toolbar_btn:hover {
            background-size: 110%;
        }

        .toolbar_btn_container {
            position: absolute;
            right: 0;
            bottom: 0;
            transform-origin: center center;
            transform: rotate(180deg);
        }

        .outside {
            position: absolute;
            top: 0;
            transform: rotate(0deg);
            z-index: 998;
            height: fit-content;
        }

        #canvas {
            background-color: transparent;
        }

        .button1 {
            height: 30px;
            width: 80px;
            line-height: 40px;
            font-size: 15px;
            color: gold;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            border: none;
            margin-right: 12px;
            margin-bottom: 2px;
            text-align: center;
            cursor: pointer;
        }

        .button1:hover {
            color: darkorange;
        }

        .button1:active {
            border: none;
            color: white;
            outline: none;
            background: LightSkyBlue;
        }

        .range1 {
            width: 80px;
            height: 5px;
        }

        label {
            color: gold;
        }

        label span {
            color: #48c0a4;
        }

        .preview {
            display: flex;
            justify-content: center;
            align-items: center;
        }


        .painter_mode_chose_button {
            width: 20px;
            height: 20px;
            display: inline-block;
            margin: 0 3px;
            cursor: pointer;
            background: url("painter_tools.png");
            background-repeat: no-repeat;
            background-position: var(--normal);
        }

        #画笔 {
            --normal: 0px 0px;
            --active: 0px -23px;
        }

        .painter_mode_chose_button:hover,
        .painter_mode_chose_button.active {
            background-position: var(--active);
        }


        #空心矩形 {
            --normal: 0px -45px;
            --active: 0px -67px;
        }

        #实心矩形 {
            width: 18px;
            height: 18px;
            background: #E89184;
            border-radius: 5px;
        }

        #实心矩形:hover,
        #实心矩形.active {
            background: #F64524;
        }

        #空心圆形 {
            --normal: 0px -90px;
            --active: 0px -113px;
        }

        #实心圆形 {
            width: 18px;
            height: 18px;
            background: #E89184;
            border-radius: 50%;
        }

        #实心圆形:hover,
        #实心圆形.active {
            background: #F64524;
        }

        #直线 {
            --normal: 0px -133px;
            --active: 0px -150px;
        }

        #箭头 {
            --normal: 0px -266px;
            --active: 0px -290px;
        }

        #橡皮 {
            --normal: 0px -218px;
            --active: 0px -241px;
        }

        #brushSizeLine {
            margin: 0;
            padding: 0;
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: gold;
        }

        #eraserSizeLine {
            margin: 0;
            padding: 0;
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: gold;
        }
    </style>
    <!-- 其他css-->
    <style>
        body {
            overflow: hidden;
        }

        .scene {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .info {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .info * {
            margin-bottom: 10px;
        }

        .info h1 {
            margin-bottom: 30px;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            text-align: center;
        }


        ol {
            margin: 0;
            padding: 0;
            list-style: none;
            width: 200px;
            text-align: left;
        }

        ol li {
            margin-bottom: 10px;
        }

        .info_left {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: center;
            width: 200px;
            margin-right: 20%;
        }

        #players {
            height: 200px;
            /*超出范围添加滑动条*/
            overflow-y: scroll;
            border: 1px solid #ccc;
        }

        #ready_players {
            height: 200px;
            /*超出范围添加滑动条*/
            overflow-y: scroll;
            border: 1px solid #ccc;
        }

        .pic_btn {
            background: none;
        }

        .chatball {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 70px;
            height: 70px;
            z-index: 1002;
        }

        .chatball button {
            height: 100%;
            width: 100%;
            background: url("chat.png");
            background-repeat: no-repeat;
            background-size: 100%;
        }

        .chatball button:hover {
            background-size: 110%;
        }

        .chatbox {
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            width: 300px;
            z-index: 1001;
            background-color: aliceblue;
            padding-left: 8px;
        }

        .chatbox ul {
            height: 60%;
            overflow-y: scroll;
            padding: 10px;
            /*边框*/
            border: 1px solid #ccc;
        }

        .chatbox ul li {
            margin-bottom: 10px;
            text-align: left;
        }

        .black {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .info_lefttop {
            position: absolute;
            top: 10px;
            width: 100%;
            z-index: 998;
        }

        .bg {
            background-color: aliceblue;
            padding: 1;
            width: fit-content;
        }

        .info_top {
            position: absolute;
            top: 10px;
            width: 100%;
            left: 40%;
            z-index: 998;
            border-bottom: 1px solid #ccc;
        }

        .canvas_container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .drawing_submit {
            position: absolute;
            bottom: 0;
            left: 0;
        }

        .submit_btn {
            background: url("submit.png");
            background-repeat: no-repeat;
            background-size: 100%;
            width: 80px;
            height: 80px;
        }

        .submit_btn:hover {
            background-size: 110%;
        }


        .pic {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .info_bottom {
            position: absolute;
            bottom: 10px;
            width: 100%;
            left: 40%;
            z-index: 998;
            border-top: 1px solid #ccc;
        }

        .center_window {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1001;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .center_window div {
            background-color: antiquewhite;
        }
    </style>

    <div id="server" class="scene info" style="display: none;">
        <h1>Draw&Duess</h1>
        <input type="text" id="nickname" placeholder="你的昵称..." style="width: 200px;">
        <input type="text" id="server_url" placeholder="服务器地址..." style="width: 200px;">
        <button onclick="connectServer()">连接服务器</button>
    </div>

    <div id="prepare" style="display: none;" class="scene info">
        <h1>准备阶段</h1>
        <div class="info_left">
            <ol id="players"></ol>
            <span>人数：<span id="num_of_players"></span></span>
        </div>
        <p>等待开始游戏...</p>
    </div>

    <div id="drawing_phase" style="display: ;" class="scene">
        <div class="info_lefttop">
            <div class="bg">倒计时：<span id="countdown_draw"></span>秒</div>
        </div>
        <div class="info_top">
            <div class="bg">题目：<span id="word"></span></div>
        </div>
        <div class="board">
            <div class="toolbar" id="toolbar" style="display: none;">
                <div class="content">
                    <div style="float: left;">
                        <button class="button1" onclick="clearCanvas()">清空</button>
                        <button class="button1" onclick="undo()">撤销</button>
                    </div>
                    <div style="float: left;">
                        <button class="button1" onclick="restore()">恢复</button>
                        <button class="button1" onclick="save_pic()">保存</button>
                    </div>
                    <div>
                        <input type="color" id="brushColor" style="width: 78px;">
                    </div>
                    <div style="float: left;">
                        <div>
                            <span class="painter_mode_chose_button" id="画笔" onclick="change_mode('画笔',7);"></span>
                            <span class="painter_mode_chose_button" id="橡皮" onclick="change_mode('橡皮',8);"></span>
                        </div>
                        <div>
                            <span class="painter_mode_chose_button" id="空心矩形" onclick="change_mode('空心矩形',1);"></span>
                            <span class="painter_mode_chose_button" id="实心矩形" onclick="change_mode('实心矩形',2);"></span>
                        </div>
                    </div>
                    <div style="float: left;">
                        <div>
                            <span class="painter_mode_chose_button" id="空心圆形" onclick="change_mode('空心圆形',3);"></span>
                            <span class="painter_mode_chose_button" id="实心圆形" onclick="change_mode('实心圆形',4);"></span>
                        </div>
                        <div>
                            <span class="painter_mode_chose_button" id="直线" onclick="change_mode('直线',5);"></span>
                            <span class="painter_mode_chose_button" id="箭头" onclick="change_mode('箭头',6);"></span>
                        </div>
                    </div>

                    <div style="margin: 0;">
                        <div>
                            <label for="brushSize">画笔 <span id="brushSizeValue">5</span></label>
                        </div>
                        <div style="margin: 0;">
                            <input class="range1" type="range" id="brushSize" min="1" max="50" value="5"
                                onchange="updateValue('brushSize')" oninput="updateLine('brushSize', 'brushSizeLine')">
                            <div style="width: 80px;height: 50px" class="preview">
                                <div id="brushSizeLine"></div>
                            </div>
                        </div>
                    </div>
                    <div style="margin: 0;">
                        <div>
                            <label for="eraserSize">橡皮 <span id="eraserSizeValue">20</span></label>
                        </div>
                        <div style="margin: 0;">
                            <input class="range1" type="range" id="eraserSize" min="1" max="80" value="20"
                                onchange="updateValue('eraserSize')"
                                oninput="updateLine('eraserSize', 'eraserSizeLine')">
                            <div style="width: 80px;height: 80px" class="preview">
                                <div id="eraserSizeLine"></div>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="toolbar_btn_container"><button onclick="toolbar()" class="toolbar_btn"></button></div>
            </div>
            <div class="toolbar_btn_container outside"><button onclick="toolbar()" class="toolbar_btn"></button></div>
            <div class="canvas_container">
                <canvas id="canvas" width="1730" height="650"></canvas>
            </div>
        </div>
        <div class="drawing_submit">
            <button onclick="submit_pic()" class="submit_btn"></button>
        </div>
    </div>

    <div id="waiting" style="display: none;" class="center_window">
        <div>
            <h3>等待其他玩家...(<span id="ready_players_num"></span>)</h3>
            <ol id="ready_players"></ol>
        </div>
    </div>


    <div id="guess_phase" style="display: none;" class="scene">
        <div class="info_lefttop">
            <div class="bg">倒计时：<span id="countdown_guess"></span>秒</div>
        </div>
        <img id="pic" src="" alt="图片" class="pic">
        <div class="info_top">
            <div class="bg">
                <input type="text" id="guess" placeholder="请输入你的答案" style="width: 200px;" autocomplete="off">
                <button onclick="submitGuess()">提交答案</button>
            </div>
        </div>
    </div>

    <div id="appreciation_phase" style="display: none;" class="scene">
        <div class="info_top">
            <div class="bg"><span id="drawer"></span>画了：<span id="appr_word"></span></div>
        </div>
        <img id="appr_pic" src="" alt="图片" class="pic">
        <div class="info_bottom">
            <div class="bg"><span id="guesser">xxxxxxx</span></div>
        </div>

        <div class="center_window" style="display: none;" id="match_window">
            <div>
                <p>倒计时：<span id="countdown_appreciation"></span>秒</p>
                <p id="appreciation_result"></p>
                <p id="is_match">认为匹配吗？</p>
                <button onclick="match('1')">匹配</button>
                <button onclick="match('0')" id="unmatch">不匹配</button>
            </div>
        </div>
    </div>

    <div id="favourite" style="display: none;" class="center_window">
        <div>
            <div id="if_not_the_one">
                <span id="the_one"></span>正在选择ta最喜欢的画作...
            </div>
            <div style="display: none;" id="if_the_one">
                <p>你最喜欢哪幅图？</p>
            </div>
            <p>倒计时：<span id="countdown_favourite"></span>秒</p>
            <ol id="choice_list"></ol>
        </div>
    </div>

    <div id="favourite_choosed" style="display: none;" class="center_window">
        <div>
            <p><span id="chooser"></span>选择了ta最喜欢的画作：</p>
            <img id="favourite_pic" src="" alt="图片" width="200px" height="200px">
        </div>
    </div>

    <div id="game_over" style="display: none;" class="scene">
        <h2>游戏结束</h2>
        <ol id="rank"></ol>
        <button onclick="restart()">再来一局</button> <!-- to do -->
    </div>


    <div class="chatball"><button class="pic_btn" onclick="chatbox()"></button></div>
    <div class="black" id="black" style="display: none;"></div>
    <div id="chat" class="chatbox" style="display: none;">
        <h2>消息</h2>
        <ul id="messages"></ul>
        <input id="chat_input" autocomplete="off" />
        <button onclick="chat_send()">发送</button>
    </div>
    </div>
    <script>
        // 游戏核心代码
        var socket;
        var nickname;
        var player_id;
        var players;
        var phase = "prepare";  // prepare, draw, guess, appreciation, favourite
        var the_one;  // 选择最喜欢的画作阶段中，那个选择的人(id)
        var is_black = false;  // 除了聊天框，是否有其他功能需求遮罩层
        var appreciation;
        var ready_num;

        // 检查是否保存了用户名，服务器地址，id
        if (localStorage.getItem('dg_nickname')) {
            nickname = localStorage.getItem('dg_nickname');
            document.getElementById('nickname').value = nickname;
        }
        if (localStorage.getItem('dg_server_url')) {
            serverUrl = localStorage.getItem('dg_server_url');
            document.getElementById('server_url').value = serverUrl;
        }

        if (localStorage.getItem('dg_player_id')) {
            player_id = localStorage.getItem('dg_player_id');
        }


        function connectServer() {
            var serverUrl = document.getElementById('server_url').value;
            nickname = document.getElementById('nickname').value;
            // 检查输入是否合法
            if (!serverUrl) {
                alert('请输入服务器地址');
                return;
            }
            if (!nickname) {
                alert('请输入昵称');
                return;
            }
            // 保存用户名和服务器地址
            localStorage.setItem('dg_nickname', nickname);
            localStorage.setItem('dg_server_url', serverUrl);
            socket = new WebSocket("ws://" + serverUrl);
            socket.onopen = function () {
                console.log('WebSocket连接成功');
                if (player_id) {
                    socket.send("[reconnect]" + player_id);
                } else {
                    socket.send("[initialization]" + nickname);
                }
            };
            socket.onmessage = function (event) {
                console.log('服务器返回消息：', event.data);
                // 如果是"name_exists"，表示昵称已存在
                if (event.data == 'name_exists') {
                    alert('房间内已有同名玩家，请更换昵称');
                    return;
                }
                // 如果是"playing"，表示游戏已经开始
                if (event.data == 'playing') {
                    alert('游戏已经开始，请等待下一局');
                    return;
                }
                // 如果以[new_player]开头，表示有新玩家加入
                if (event.data.startsWith('[new_player]')) {
                    var player = event.data.substring(12);
                    var li = document.createElement('li');
                    li.textContent = player;
                    document.getElementById('players').appendChild(li);
                    document.getElementById('num_of_players').textContent = document.getElementById('players').getElementsByTagName('li').length;

                    chat('<span style="color: gold">' + player + '加入了游戏' + '</span>');
                    players.push(player);
                }
                // 如果以[all_players]开头，表示返回了一个包含所有玩家的json列表
                if (event.data.startsWith('[all_players]')) {
                    players = JSON.parse(event.data.substring(13));
                    players.forEach(function (player) {
                        var li = document.createElement('li');
                        li.textContent = player;
                        document.getElementById('players').appendChild(li);
                    });
                    document.getElementById('num_of_players').textContent = document.getElementById('players').getElementsByTagName('li').length;
                }
                // 如果以[id]开头，表示返回了玩家的id
                if (event.data.startsWith('[id]')) {
                    player_id = event.data.substring(4);
                    localStorage.setItem('dg_id', player_id);
                }
                // 如果以[draw]开头，表示进入画图阶段
                if (event.data.startsWith('[draw]')) {
                    phase = 'draw';
                    document.getElementById('ready_players').innerHTML = '';
                    ready_num = 0;
                    clearCanvas();
                    document.getElementById('prepare').style.display = 'none';
                    clear_window();
                    document.getElementById('toolbar').style.display = 'none';
                    document.getElementById('guess_phase').style.display = 'none';
                    document.getElementById('drawing_phase').style.display = '';
                    document.getElementById('word').textContent = event.data.substring(6);
                    const timestamp = new Date().getTime();
                    var time = 120 - Math.ceil(timestamp / 1000);
                    document.getElementById('countdown_draw').textContent = time;
                    var interval = setInterval(function () {
                        time--;
                        document.getElementById('countdown_draw').textContent = time;
                        if (time <= 0 || phase != 'draw') {
                            if (time <= 0) { submit_pic(); }
                            clearInterval(interval);
                        }
                    }, 1000);
                }
                // 如果以[guess]开头，表示返回了题目
                if (event.data.startsWith('[guess]')) {
                    phase = 'guess';
                    document.getElementById('ready_players').innerHTML = '';
                    ready_num = 0;
                    document.getElementById('guess').value = '';
                    clear_window();
                    document.getElementById('drawing_phase').style.display = 'none';
                    document.getElementById('guess_phase').style.display = '';
                    document.getElementById('pic').src = event.data.substring(7);
                    const timestamp = new Date().getTime();
                    var time = 60 - Math.ceil(timestamp / 1000);
                    document.getElementById('countdown_guess').textContent = time;
                    var interval = setInterval(function () {
                        time--;
                        document.getElementById('countdown_guess').textContent = time;
                        if (time <= 0 || phase != 'guess') {
                            if (time <= 0) { submitGuess(); }
                            clearInterval(interval);
                        }
                    }, 1000);
                }
                // 如果以[done]开头，表示有人完成
                if (event.data.startsWith('[done]')) {
                    var id = event.data.substring(6);
                    chat('<span style="color: gold">' + id + '完成了' + '</span>');
                    var li = document.createElement('li');
                    li.innerHTML = id + "<img src='right.png' width='20' height='20'>";
                    document.getElementById('ready_players').appendChild(li);
                    ready_num++;
                    document.getElementById('ready_players_num').textContent = ready_num + '/' + players.length;
                }
                // 如果以[appreciation]开头，表示返回了json评价
                if (event.data.startsWith('[appreciation]')) {
                    phase = 'appreciation';
                    document.getElementById('black').style.display = 'none';
                    document.getElementById('chat').style.display = 'none';
                    document.getElementById('waiting').style.display = 'none';
                    document.getElementById('favourite_choosed').style.display = 'none';
                    is_black = false;
                    document.getElementById('guess_phase').style.display = 'none';
                    document.getElementById('appreciation_phase').style.display = '';
                    document.getElementById('favourite').style.display = 'none';
                    appreciation = JSON.parse(event.data.substring(14));

                    var index = 0;

                    function a() {

                        if (index > appreciation.pictures.length - 1) {

                            show_match_window();
                            clearInterval(timer);
                            return;
                        }
                        var picture = appreciation.pictures[index];
                        document.getElementById('drawer').textContent = appreciation.players[index * 2]
                        if (index == 0) {
                            document.getElementById('appr_word').textContent = appreciation.first_word;
                        } else {
                            document.getElementById('appr_word').textContent = appreciation.words[index - 1];
                        }

                        document.getElementById("appr_pic").src = picture;
                        // to-do: 展现绘画过程

                        var guesser = document.getElementById("guesser");
                        var guesser_text = appreciation.words[index];
                        guesser.textContent = appreciation.players[index * 2 + 1];
                        if (index == appreciation.pictures.length - 1) {
                            var ad = new Audio("long_announce.mp3");
                            ad.ontimeupdate = function () {
                                if (ad.currentTime > 2.855 && !showed) { show_res(); showed = true; }
                            }
                        } else {
                            var ad = new Audio("short_announce.mp3");
                            ad.ontimeupdate = function () {
                                if (ad.currentTime > 2.16 && !showed) { show_res(); showed = true; }
                            }
                        }
                        var showed = false;
                        ad.play();
                        function show_res() {
                            if (guesser_text.endsWith("(新词)")) {
                                guesser.textContent += " 什么也没猜到！新词：" + guesser_text.substring(0, guesser_text.length - 3);
                            } else {
                                guesser.textContent += " 猜了：" + guesser_text;
                            }
                        }
                        index++;

                    }
                    a();
                    var timer = setInterval(a, 5000);

                    const timestamp = new Date().getTime();
                    var time = 20 + appreciation.pictures.length * 5 - Math.ceil(timestamp / 1000);
                    document.getElementById('countdown_appreciation').textContent = time;
                    var interval = setInterval(function () {
                        time--;
                        document.getElementById('countdown_appreciation').textContent = time;
                        if (time <= 0 || phase != 'appreciation') {
                            clearInterval(interval);
                        }
                    }, 1000);
                    function show_match_window() {
                        document.getElementById('match_window').style.display = '';
                        document.getElementById('black').style.display = '';
                        is_black = true;
                    }

                    document.getElementById('appreciation_result').textContent = appreciation.first_word + " -> " + appreciation.words[appreciation.words.length - 1];
                    if (appreciation.first_word == appreciation.words[appreciation.words.length - 1]) {
                        document.getElementById('is_match').innerHTML = "完全匹配！";
                        document.getElementById('unmatch').style.display = 'none';
                    }

                    document.getElementById('ready_players').innerHTML = '';
                    ready_num = 0;
                    // 设置#choice_list的内容

                    var choice_list = document.getElementById('choice_list');
                    choice_list.innerHTML = '';
                    for (var i = 0; i < appreciation.pictures.length; i++) {
                        var option = document.createElement('button');
                        option.value = i;
                        option.innerHTML = "<img src='" + appreciation.pictures[i] + "' width='100px' height='100px'>";
                        option.onclick = choosePicture(i);
                        option.classList.add('choice_button');
                        choice_list.appendChild(option);
                    }



                }
                // 如果以[favourite]开头，则表示进入评价最喜欢的画作阶段
                if (event.data.startsWith('[favourite]')) {
                    phase = 'favourite';
                    document.getElementById('favourite').style.display = '';
                    document.getElementById('waiting').style.display = 'none';
                    document.getElementById('match_window').style.display = 'none';
                    document.getElementById('black').style.display = '';
                    is_black = true;
                    if (nickname == event.data.substring(11)) {
                        document.getElementById('if_the_one').style.display = '';
                        document.getElementById('if_not_the_one').style.display = 'none';
                        Array.prototype.forEach.call(document.getElementsByClassName('choice_button'), function (button) {
                            button.disabled = false;
                        });
                        // #choic_list的内容在appreciation阶段设置

                    } else {
                        document.getElementById('the_one').innerHTML = event.data.substring(11);
                        document.getElementById('if_the_one').style.display = 'none';
                        document.getElementById('if_not_the_one').style.display = '';
                        Array.prototype.forEach.call(document.getElementsByClassName('choice_button'), function (button) {
                            button.disabled = true;
                        });
                    }
                    const timestamp = new Date().getTime();
                    var time = 20 - Math.ceil(timestamp / 1000);
                    document.getElementById('countdown_favourite').textContent = time;
                    var interval = setInterval(function () {
                        time--;
                        document.getElementById('countdown_favourite').textContent = time;
                        if (time <= 0 || phase != 'favourite') {
                            clearInterval(interval);
                        }
                    }, 1000);
                }
                // 如果以[favourite_choosed]开头，则表示最喜欢的画作被选择了
                if (event.data.startsWith('[favourite_choosed]')) {
                    new Audio("win.mp3").play();
                    document.getElementById('favourite').style.display = 'none';
                    document.getElementById('waiting').style.display = 'none';
                    document.getElementById('favourite_choosed').style.display = '';
                    document.getElementById('chooser').textContent = appreciation.players[0];
                    document.getElementById('favourite_pic').src =
                        appreciation.pictures[event.data.substring(19)];
                    chat('<span style="color: gold">' + "第" + (Number(event.data.substring(19)) + 1) + "张画作被选为最喜欢的画作" + "</span>");
                }
                // 如果以[checked]开头，表示有人已经评价了画作
                if (event.data.startsWith('[checked]')) {
                    var data = event.data.substring(9).split(',');
                    chat('<span style="color: gold">' + data[0] + "评价：" + data[1] + "</span>");
                    var rd_players = document.getElementById('ready_players');
                    rd_players.appendChild(document.createElement('li')).innerHTML = data[0] + "<img height='20px' width='20px' src='" + data[1] + ".png'>";
                    ready_num++;
                    document.getElementById('ready_players_num').innerHTML = ready_num + "/" + players.length;
                    new Audio("check.mp3").play();
                }
                // 如果以[end]开头，则表示游戏结束
                if (event.data.startsWith('[end]')) {
                    phase = 'prepare';
                    document.getElementById('game_over').style.display = '';
                    document.getElementById('waiting').style.display = 'none';
                    document.getElementById('appreciation_phase').style.display = 'none';
                    document.getElementById('favourite').style.display = 'none';
                    document.getElementById('favourite_choosed').style.display = 'none';
                    document.getElementById('black').style.display = 'none';
                    is_black = false;
                    document.getElementById('chat').style.display = 'none';
                    var grades = event.data.substring(5); //这是json字符串数组
                    grades = JSON.parse(grades); //将json字符串数组转换为JavaScript数组
                    var rank_display = document.getElementById('rank');
                    rank_display.innerHTML = '';
                    for (var i = 0; i < grades.length; i++) {
                        var rank_item = document.createElement('li');
                        rank_item.innerHTML = grades[i][0] + '：' + grades[i][1];
                        rank_display.appendChild(rank_item);
                    }
                }
                // 如果以[leave]开头，则表示有人离开了房间
                if (event.data.startsWith('[leave]')) {
                    var data = event.data.substring(7);
                    chat('<span style="color: gold">' + data + "离开了房间" + "</span>");
                    if (phase == "prepare") {
                        if (players.indexOf(data) != -1) {
                            players.splice(players.indexOf(data), 1);
                            document.getElementById('players').innerHTML = '';
                            players.forEach(function (player) {
                                var li = document.createElement('li');
                                li.textContent = player;
                                document.getElementById('players').appendChild(li);
                            });
                            document.getElementById('num_of_players').textContent = document.getElementById('players').getElementsByTagName('li').length;
                        }
                    }
                }
                // 如果以[chat]开头，表示有人发送了消息
                if (event.data.startsWith('[chat]')) {
                    var data = event.data.substring(6);
                    chat(data);
                }
            };
            socket.onclose = function () {
                console.log('WebSocket连接关闭');
            };
            socket.onerror = function () {
                console.log('WebSocket连接出错');
            };
            document.getElementById('server').style.display = 'none';
            document.getElementById('prepare').style.display = '';
        }

        // 提交图片
        function submit_pic() {
            socket.send("[draw]" + JSON.stringify(undoStack));
            document.getElementById('black').style.display = '';
            is_black = true;
            document.getElementById('waiting').style.display = '';
        }

        // 提交答案
        function submitGuess() {
            var guess = document.getElementById('guess').value;
            socket.send("[guess]" + guess);
            document.getElementById('black').style.display = '';
            is_black = true;
            document.getElementById('waiting').style.display = '';
        }

        // 是否匹配
        function match(is_matched) {
            socket.send("[appreciation]" + is_matched);
            document.getElementById('waiting').style.display = '';
            document.getElementById('match_window').style.display = 'none';
        }

        // 闭包

        function choosePicture(outerVariable) {
            // 选择最喜欢的画作
            return function () {
                socket.send("[favourite]" + outerVariable);
                document.getElementById('favourite').style.display = 'none';
                document.getElementById('waiting').style.display = '';
            }
        }

        // chatbox
        function chatbox() {
            if (document.getElementById('chat').style.display == '') {
                document.getElementById('chat').style.display = 'none';
                if (!is_black) { document.getElementById('black').style.display = 'none'; }
            } else {
                document.getElementById('chat').style.display = '';
                document.getElementById('black').style.display = '';
            }
        }

        // toolbar
        function toolbar() {
            if (document.getElementById('toolbar').style.display == '') {
                document.getElementById('toolbar').style.display = 'none';
            } else {
                document.getElementById('toolbar').style.display = '';
            }
        }

        function clear_window() {
            if (phase != "appreiation") {
                document.getElementById('black').style.display = 'none';
                is_black = false;
                document.getElementById('chat').style.display = 'none';
                document.getElementById('waiting').style.display = 'none';
            }
        }

        function restart() {
            socket.send("[initialization]" + nickname);
            document.getElementById('prepare').style.display = '';
            document.getElementById('game_over').style.display = 'none';
            document.getElementById('rank').innerHTML = '';
        }

        function chat(message) {
            var chat_display = document.getElementById('messages');
            var chat_item = document.createElement('li');
            chat_item.innerHTML = message;
            chat_display.appendChild(chat_item);
            chat_display.scrollTop = chat_display.scrollHeight;
        }

        function chat_send() {
            socket.send("[chat]" + document.getElementById('chat_input').value);
            document.getElementById('chat_input').value = '';
        }

        // 画板代码


        // 当前画笔模式：1 空心矩形 2 实心矩形 3 空心圆形 4 实心圆形 5 直线 6 箭头 7 自由画笔 8 橡皮
        let brush = 7;

        // 获取画布和绘画工具
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // 调整画布大小以适应窗口
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        // 跟踪绘画状态
        ctx.lineJoin = 'round';
        ctx.lineCap = 'round';
        let isDrawing = false; //标记是否要绘制
        let isMouseDown = false; //标记鼠标是否按下
        let lineColor; // 线条颜色
        let lineWidth; // 线条粗细
        let points = []; //存储坐标点
        let undoStack = []; // 存储画布状态，用于撤销上一步操作
        let step = 0; // 记录当前步数


        // 鼠标按下
        canvas.onpointerdown = function (e) {
            points = [];
            isDrawing = true;
            isMouseDown = true;
            points.push({ x: e.offsetX, y: e.offsetY });
            if (e.ctrlKey || brush === 8) { // 如果是橡皮擦，则设置为destination-out
                ctx.globalCompositeOperation = 'destination-out';
            } else { // 否则设置为默认值source-over
                ctx.globalCompositeOperation = 'source-over';
            }
            ctx.beginPath(); // 新增：开始一个绘画路径
        };


        // 鼠标抬起
        canvas.onpointerup = function (e) {
            isMouseDown = false;
            points = [];
            isDrawing = false;
            ctx.closePath(); // 新增：结束绘画路径
            // 绘画结束后，将值重新设置为默认值，否则当前值为destination-out时，使用撤销功能后会把整个画布的内容都给擦掉
            ctx.globalCompositeOperation = 'source-over';
            addUndoStack(canvas.toDataURL("image/webp", 0.5)); // 将当前画布状态保存起来
        };
        // 鼠标离开画布
        canvas.onpointerout = function (e) {
            if (isMouseDown) {
                points = [];
                isDrawing = false;
                isMouseDown = false;
                ctx.closePath(); // 新增：结束绘画路径
                ctx.globalCompositeOperation = 'source-over';
                // 绘画结束后，将值重新设置为默认值，否则当前值为destination-out时，使用撤销功能后会把整个画布的内容都给擦掉
                addUndoStack(canvas.toDataURL("image/webp", 0.5)); // 将当前画布状态保存起来
            }
        };

        // 鼠标移动
        canvas.onpointermove = function (e) {
            if (!isDrawing) return;
            const brushSize = document.getElementById('brushSize').value;
            const eraserSize = document.getElementById('eraserSize').value;
            lineWidth = (e.ctrlKey || brush === 8) ? eraserSize : brushSize;
            lineColor = document.getElementById('brushColor').value;
            ctx.lineWidth = lineWidth;
            ctx.strokeStyle = lineColor;
            draw(e.offsetX, e.offsetY, e.ctrlKey);
        };

        window.addEventListener('touchstart', function check_touch() {
            console.log('检测到触摸屏');
            canvas.onpointermove = function (e) {
            }
            canvas.onpointerup = function (e) {
            }
            canvas.onpointerdown = function (e) {
            }
            canvas.onpointerout = function (e) {
            }
            window.removeEventListener('touchstart', check_touch);
        });

        // 触摸
        canvas.addEventListener('touchmove', (e) => {
            if (!isDrawing) return;
            const brushSize = document.getElementById('brushSize').value;
            const eraserSize = document.getElementById('eraserSize').value;
            lineWidth = (e.ctrlKey || brush === 8) ? eraserSize : brushSize;
            lineColor = document.getElementById('brushColor').value;
            ctx.lineWidth = lineWidth;
            ctx.strokeStyle = lineColor;
            draw(e.touches[0].clientX, e.touches[0].clientY, e.ctrlKey);

        }, { passive: false });

        canvas.addEventListener('touchstart', (e) => {
            points = [];
            isDrawing = true;
            isMouseDown = true;
            points.push({ x: e.touches[0].clientX, y: e.touches[0].clientY });
            if (e.ctrlKey || brush === 8) { // 如果是橡皮擦，则设置为destination-out
                ctx.globalCompositeOperation = 'destination-out';
            } else { // 否则设置为默认值source-over
                ctx.globalCompositeOperation = 'source-over';
            }
            ctx.beginPath(); // 新增：开始一个绘画路径
        }, { passive: false });
        canvas.addEventListener('touchend', (e) => {
            isMouseDown = false;
            points = [];
            isDrawing = false;
            ctx.closePath(); // 新增：结束绘画路径
            // 绘画结束后，将值重新设置为默认值，否则当前值为destination-out时，使用撤销功能后会把整个画布的内容都给擦掉
            ctx.globalCompositeOperation = 'source-over';
            addUndoStack(canvas.toDataURL("image/webp", 0.5)); // 将当前画布状态保存起来
        }, { passive: false });

        // 绘制
        function draw(mousex, mousey, ctrlKey) {
            points.push({ x: mousex, y: mousey });
            if (ctrlKey || brush === 7 || brush === 8) { // 如果是橡皮擦模式，则和画笔模式一样，用draw画笔方法。
                draw画笔();
            } else {
                if (brush === 1) draw矩形(false);
                else if (brush === 2) draw矩形(true);
                else if (brush === 3) draw圆形(false);
                else if (brush === 4) draw圆形(true);
                else if (brush === 5) draw直线();
                else if (brush === 6) draw箭头();
            }
            ctx.stroke();
            points.slice(0, 1);
        }

        // 绘制自由线条
        function draw画笔() {
            ctx.beginPath();
            let x = (points[points.length - 2].x + points[points.length - 1].x) / 2,
                y = (points[points.length - 2].y + points[points.length - 1].y) / 2;
            if (points.length == 2) {
                ctx.moveTo(points[points.length - 2].x, points[points.length - 2].y);
                ctx.lineTo(x, y);
            } else {
                let lastX = (points[points.length - 3].x + points[points.length - 2].x) / 2,
                    lastY = (points[points.length - 3].y + points[points.length - 2].y) / 2;
                ctx.moveTo(lastX, lastY);
                ctx.quadraticCurveTo(points[points.length - 2].x, points[points.length - 2].y, x, y);
            }
        }

        // 绘制矩形
        function draw矩形(isSolid) {
            const startX = points[0].x;
            const startY = points[0].y;
            const endX = points[points.length - 1].x;
            const endY = points[points.length - 1].y;
            ctx.clearRect(0, 0, canvas.width, canvas.height); // 清空画布
            ctx.beginPath();
            if (isSolid) { // 是否实心，true绘制实心矩形，false绘制空心矩形
                ctx.fillStyle = lineColor;
                ctx.fillRect(startX, startY, endX - startX, endY - startY);
            } else {
                ctx.rect(startX, startY, endX - startX, endY - startY);
            }
            loadImage(); // 清空画布后，显示画布之前的状态，不然画布上同时只能存在一个图形
        }

        // 绘制圆形
        function draw圆形(isSolid) {
            const startX = points[0].x;
            const startY = points[0].y;
            const endX = points[points.length - 1].x;
            const endY = points[points.length - 1].y;
            const radius = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
            ctx.clearRect(0, 0, canvas.width, canvas.height); // 清空画布
            ctx.beginPath();
            ctx.arc(startX, startY, radius, 0, 2 * Math.PI);
            if (isSolid) { // 绘制实心圆
                ctx.fillStyle = lineColor;
                ctx.fill();
            }
            loadImage(); // 清空画布后，显示画布之前的状态，不然画布上同时只能存在一个图形
        }

        // 绘制直线
        function draw直线() {
            const startX = points[0].x;
            const startY = points[0].y;
            const endX = points[points.length - 1].x;
            const endY = points[points.length - 1].y;
            ctx.clearRect(0, 0, canvas.width, canvas.height); // 清空画布
            ctx.beginPath();
            ctx.moveTo(startX, startY);
            ctx.lineTo(endX, endY);
            loadImage(); // 清空画布后，显示画布之前的状态，不然画布上同时只能存在一个图形
        }

        // 绘制箭头
        function draw箭头() {
            const startX = points[0].x;
            const startY = points[0].y;
            const endX = points[points.length - 1].x;
            const endY = points[points.length - 1].y;
            const arrowSize = lineWidth * 4; // 箭头大小（根据线条粗细来调整箭头大小）
            ctx.clearRect(0, 0, canvas.width, canvas.height); // 清空画布
            ctx.beginPath();
            ctx.moveTo(startX, startY);
            ctx.lineTo(endX, endY);
            // 计算箭头角度
            const angle = Math.atan2(endY - startY, endX - startX);
            // 绘制箭头部分
            ctx.lineTo(
                endX - arrowSize * Math.cos(angle - Math.PI / 6),
                endY - arrowSize * Math.sin(angle - Math.PI / 6)
            );
            ctx.moveTo(endX, endY);
            ctx.lineTo(
                endX - arrowSize * Math.cos(angle + Math.PI / 6),
                endY - arrowSize * Math.sin(angle + Math.PI / 6)
            );
            loadImage(); // 清空画布后，显示画布之前的状态，不然画布上同时只能存在一个图形
        }


        // 加载图片
        function loadImage() {
            if (step > 0) {
                var img = new Image();
                img.src = undoStack[step - 1];
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            }
        }

        // 清空画布
        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            step = 0;
            points = [];
            undoStack = []; // 清空撤销栈
        }

        // 添加操作
        function addUndoStack(url) {
            if (step < undoStack.length) {
                undoStack.length = step; // 清除撤销后的操作
            }
            undoStack.push(url);
            step++;
        }

        // 撤销操作
        function undo() {
            if (step > 1) {
                step--;
                const image = new Image();
                image.src = undoStack[step - 1]; // 获取上一个画布状态
                image.onload = function () {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(image, 0, 0); // 绘制上一个画布状态
                }
            } else {
                step = 0;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        }

        // 恢复操作
        function restore() {
            if (step < undoStack.length) {
                step++;
                const image = new Image();
                image.src = undoStack[step - 1]; // 获取下一个画布状态
                image.onload = function () {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(image, 0, 0); // 绘制下一个画布状态
                }
            }
        }

        // 保存图片
        function save_pic() {
            const image = canvas.toDataURL('image/png');
            const link = document.createElement('a');
            link.href = image;
            link.download = 'drawing.png';
            link.click();
        }

        // 更新滑块值
        function updateValue(inputId) {
            var value = document.getElementById(inputId).value;
            if (value < 10) { value = '0' + value; }
            document.getElementById(inputId + "Value").textContent = value;
        }

        // 更新画笔线条宽度
        function updateLine(inputId, lineId) {
            var value = document.getElementById(inputId).value;
            var line = document.getElementById(lineId);
            line.style.height = value + 'px';
            line.style.width = value + 'px';
        }

        function change_mode(id, val) {
            brush = val;
            update_tool_now(val);
        }

        // 监听键盘事件，实现撤销操作和保存绘画内容、切换画笔工具
        window.addEventListener('keydown', (e) => {
            // 撤销
            if (e.ctrlKey && e.key === 'z') {
                e.preventDefault();
                undo();
            }
            // 恢复
            if (e.ctrlKey && e.key === 'y') {
                e.preventDefault();
                restore();
            }
            // 保存
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                save_pic();
            }
            // 橡皮快捷键
            if (e.ctrlKey) {
                update_tool_now(8);
            }
        })
        window.addEventListener('keyup', (e) => {
            update_tool_now(brush);
        })
        function update_tool_now(target) {
            var display;
            if (target == 1) { display = '空心矩形' }
            else if (target == 2) { display = '实心矩形' }
            else if (target == 3) { display = '空心圆形' }
            else if (target == 4) { display = '实心圆形' }
            else if (target == 5) { display = '直线' }
            else if (target == 6) { display = '箭头' }
            else if (target == 7) { display = '画笔' }
            else if (target == 8) { display = '橡皮' }

            Array.prototype.forEach.call(document.getElementsByClassName('painter_mode_chose_button'), function (element) {
                if (element.classList.contains('active')) {
                    element.classList.remove('active');
                }
            });
            document.getElementById(display).classList.add('active');
        }


    </script>

</body>

</html>